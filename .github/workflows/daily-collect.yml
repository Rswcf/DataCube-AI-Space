name: Daily Collection

on:
  schedule:
    # Fire at both possible UTC slots, then gate in script to Berlin 23:xx.
    - cron: "7 21 * * *"
    - cron: "7 22 * * *"
  workflow_dispatch:
    inputs:
      period_id:
        description: "Period ID (e.g. 2026-02-08 or 2026-kw06)"
        required: false

jobs:
  collect:
    name: Trigger daily collection
    runs-on: ubuntu-latest
    steps:
      - name: Trigger collection via API
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            BERLIN_HOUR=$(TZ=Europe/Berlin date +%H)
            if [ "$BERLIN_HOUR" != "23" ]; then
              echo "Skip: now is not 23:xx in Europe/Berlin (hour=$BERLIN_HOUR)"
              exit 0
            fi
          fi

          PERIOD="${{ github.event.inputs.period_id }}"
          if [ -z "$PERIOD" ]; then
            PERIOD=$(TZ=Europe/Berlin date +%F)
          fi

          URL="${{ secrets.API_BASE_URL }}/admin/collect?week_id=${PERIOD}&wait=true"
          echo "Triggering synchronous collection: $URL"

          MAX_RETRIES=3
          RETRY_DELAY=30

          for ATTEMPT in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $ATTEMPT/$MAX_RETRIES..."

            HTTP_CODE=$(curl -sS -o response.json -w "%{http_code}" \
              -X POST "$URL" \
              -H "X-API-Key: ${{ secrets.ADMIN_API_KEY }}" \
              --max-time 7200)

            cat response.json
            echo ""

            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "Collection triggered successfully (HTTP $HTTP_CODE)"
              exit 0
            fi

            echo "ERROR: API returned HTTP $HTTP_CODE"

            if [ "$ATTEMPT" -lt "$MAX_RETRIES" ]; then
              echo "Retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
              RETRY_DELAY=$((RETRY_DELAY * 2))
            fi
          done

          echo "All $MAX_RETRIES attempts failed"
          exit 1
