name: Daily Collection

on:
  schedule:
    # Fire at both possible UTC slots, then gate in script to Berlin 23:xx.
    - cron: "7 21 * * *"
    - cron: "7 22 * * *"
  workflow_dispatch:
    inputs:
      period_id:
        description: "Period ID (e.g. 2026-02-08 or 2026-kw06)"
        required: false

jobs:
  collect:
    name: Trigger daily collection
    runs-on: ubuntu-latest
    steps:
      - name: Trigger collection via API
        id: collect
        run: |
          set +e

          if [ "${{ github.event_name }}" = "schedule" ]; then
            BERLIN_HOUR=$(TZ=Europe/Berlin date +%H)
            if [ "$BERLIN_HOUR" != "23" ]; then
              echo "Skip: now is not 23:xx in Europe/Berlin (hour=$BERLIN_HOUR)"
              echo "COLLECTED=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi

          PERIOD="${{ github.event.inputs.period_id }}"
          if [ -z "$PERIOD" ]; then
            PERIOD=$(TZ=Europe/Berlin date +%F)
          fi
          echo "PERIOD=$PERIOD" >> "$GITHUB_OUTPUT"

          # Async trigger (no wait=true) to avoid Varnish proxy 503 on long requests
          URL="${{ secrets.API_BASE_URL }}/admin/collect?week_id=${PERIOD}"
          echo "Triggering async collection: $URL"

          HTTP_CODE=$(curl -sS -o response.json -w "%{http_code}" \
            -X POST "$URL" \
            -H "X-API-Key: ${{ secrets.ADMIN_API_KEY }}" \
            --http1.1 \
            --max-time 60)
          CURL_EXIT=$?

          if [ -f response.json ]; then
            cat response.json
            echo ""
          fi

          if [ "$CURL_EXIT" -ne 0 ]; then
            echo "ERROR: curl failed with exit code $CURL_EXIT"
            echo "COLLECTED=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Collection triggered successfully (HTTP $HTTP_CODE)"
            echo "COLLECTED=true" >> "$GITHUB_OUTPUT"
          else
            echo "ERROR: API returned HTTP $HTTP_CODE"
            echo "COLLECTED=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

      - name: Wait for collection to complete
        if: steps.collect.outputs.COLLECTED == 'true'
        run: |
          PERIOD="${{ steps.collect.outputs.PERIOD }}"
          echo "Polling for content availability (period: $PERIOD)..."

          # Poll /api/tech/{period} every 60s, up to 20 minutes
          for i in $(seq 1 20); do
            HTTP_CODE=$(curl -sS -o /dev/null -w "%{http_code}" \
              "${{ secrets.API_BASE_URL }}/tech/${PERIOD}" \
              --http1.1 \
              --max-time 30)

            if [ "$HTTP_CODE" -eq 200 ]; then
              echo "Content available for $PERIOD (attempt $i)"
              exit 0
            fi

            echo "Waiting for content... attempt $i/20 (HTTP $HTTP_CODE)"
            sleep 60
          done

          echo "WARNING: Content not available after 20 minutes, proceeding anyway"

      - name: Send newsletter
        if: steps.collect.outputs.COLLECTED == 'true'
        run: |
          set +e
          PERIOD="${{ steps.collect.outputs.PERIOD }}"
          echo "Sending newsletter for period: $PERIOD"
          HTTP_CODE=$(curl -sS -o nl-response.json -w "%{http_code}" \
            -X POST "${{ secrets.API_BASE_URL }}/admin/newsletter?period_id=${PERIOD}&wait=true" \
            -H "X-API-Key: ${{ secrets.ADMIN_API_KEY }}" \
            --http1.1 \
            --max-time 300)
          CURL_EXIT=$?
          if [ -f nl-response.json ]; then
            cat nl-response.json
            echo ""
          fi
          if [ "$CURL_EXIT" -ne 0 ]; then
            echo "WARNING: Newsletter curl failed (exit $CURL_EXIT) — non-fatal"
            exit 0
          fi
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Newsletter sent successfully (HTTP $HTTP_CODE)"
          else
            echo "WARNING: Newsletter API returned HTTP $HTTP_CODE — non-fatal"
          fi
